<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>nixos-anywhere &middot; Gunwant Jain - @wantguns</title>
    <meta name="description" content="Gunwant Jain&amp;#x27;s (@wantguns) writings and musings" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://wantguns.dev/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://wantguns.dev/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="https://wantguns.dev/favicon-16x16.png" />
    <link rel="manifest" href="https://wantguns.dev/site.webmanifest" />
    <link rel="alternate" type="application/atom+xml" title="RSS" href="https://wantguns.dev/atom.xml">

    <style>:root{color-scheme:dark}html,body{background:#000;color:rgba(255,255,255,.9);padding:.3rem;margin:.3rem;text-rendering:optimizeLegibility;font-variant-ligatures:contextual;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;font-weight:400;font-size:16.5px;line-height:1.6}h1,h2,h3,h4,h5,h6{color:#fbcb97;font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;font-weight:900}h1.page_title{letter-spacing:-1px;font-weight:900;font-size:200%;line-height:normal;color:#fbcb97;margin-bottom:1rem;line-height:1.1}a{text-decoration:underline;color:rgba(255,255,255,.9)}a:visited{color:rgba(255,255,255,.9);text-decoration:none}a:active{color:#fbcb97}a:hover{color:#fbcb97}a.site_title{text-decoration:none;margin-bottom:.2rem;color:#e78a53;font-weight:900;list-style:1}a.site_title:hover{text-decoration:underline}a.site_nav{text-decoration:none;color:#e78a53}a.site_nav:hover{text-decoration:underline}a.homepage-list_title{flex:1;word-wrap:break-word;text-decoration:none;font-weight:bold;font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;color:#fbcb97}a.homepage-list_title:hover{text-decoration:underline}a code{text-decoration-color:rgba(251,203,151,.9)}a.footer{color:#888}a.footer:hover{color:#fbcb97}.pipe{color:#202020}time.site_time{font-size:90%;color:#888}span.page_time{padding:1.2rem auto;color:#888}:target{background-color:#000}hr{border:none;height:1px;background-color:#202020}::selection{background:#333}main{margin:auto;max-width:650px}header{padding-top:1rem;padding-bottom:0rem;font-weight:900}code{font-family:ui-monospace,"SFMono-Regular","SF Mono","Cascadia Code","Source Code Pro",Menlo,Consolas,"DejaVu Sans Mono",monospace;letter-spacing:normal;background-color:rgba(251,203,151,.175);padding-left:.25rem;padding-right:.25rem;font-size:14.5px;color:rgba(251,203,151,.9)}code a{text-decoration-color:rgba(251,203,151,.9)}pre{position:relative;font-family:ui-monospace,"SFMono-Regular","SF Mono","Cascadia Code","Source Code Pro",Menlo,Consolas,"DejaVu Sans Mono",monospace;font-weight:400;letter-spacing:normal;line-height:1.5;overflow:auto;border:thin solid #202020;margin:2rem 0rem;padding:1.5rem;background-color:#000}pre code{font-size:14px;padding:initial;color:inherit;background-color:inherit}.pre-wrapper{position:relative;margin:2rem 0}.copy-button{position:absolute;top:0px;right:0px;color:#fbcb97;background-color:#000;border:thin solid #202020;width:60px;height:28px;padding:5px 10px;font-size:12px;font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;font-weight:400;cursor:pointer;opacity:.8;transition:all .2s ease}.copy-button:hover{opacity:1}.copy-button.copied{border:thin solid #fbcb97}table{border-collapse:collapse;width:100%}th,td{border:1px solid #202020;padding:1.1rem}img{height:auto;margin:2rem 0rem;max-width:100%}.homepage-list,.taxonomies__list{list-style:none;padding:1rem 0}.homepage-list li,.taxonomies__list li{align-items:center;display:flex;flex-wrap:nowrap;justify-content:space-between;margin-bottom:10px}.center{margin-left:auto;margin-right:auto;max-width:100%;text-align:center}.imageClass,.videoClass{padding:.5rem}.imageClass figure,.videoClass figure{display:table}.imageClass figure img,.videoClass figure img{user-select:none}.imageClass figure figcaption,.videoClass figure figcaption{display:table-caption;caption-side:bottom;padding:.2rem;margin:.2rem auto;background-color:#fbcb97;color:#000}.imageClass figure figcaption::selection,.videoClass figure figcaption::selection{background-color:#e78a53}@media (max-width: 38rem){.homepage-list li a{width:100%}}footer{margin-top:2rem;color:#888}.pagination_title{width:100%;text-align:center;border-bottom:1px solid #202020;line-height:.1em;margin:2.5rem auto}.pagination_title span{background:#000;font-size:.8rem;padding:0 10px}.post_nav{display:flex;align-items:center;justify-content:center;text-align:center;margin:2.5rem auto 4rem auto}.post_nav .button{position:relative;display:inline-flex;flex:1;align-items:center;justify-content:center;overflow:hidden;text-decoration:none;margin:auto 1.5rem;font-weight:bold}.post_nav .button .previous,.post_nav .button .next{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.time_tag_sep{padding:.5rem;color:#888;user-select:none}.post_tags a{padding:0 .5rem 0 0;color:#888;text-decoration:none}.post_tags a:hover{color:#fbcb97}.taxonomies__title{color:#888}.taxonomies__list a{text-decoration:none}#toc-inline,#toc-aside{font-size:90%;line-height:1.6;color:#888}#toc-inline a,#toc-aside a{color:#888;text-decoration:none}#toc-inline a:hover,#toc-aside a:hover{color:#fbcb97}#toc-inline ul,#toc-aside ul{padding-left:1rem}#toc-inline li li,#toc-aside li li{list-style:disc}#toc-inline li.active>a,#toc-aside li.active>a{color:#fbcb97;font-weight:bold}#toc-inline{font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;padding:1.25rem 0rem .5rem 0rem}#toc-inline summary:hover{cursor:pointer;color:#fbcb97}#toc-aside{font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;display:block;width:15rem;position:sticky;float:left;top:3.5rem;margin-top:-1.2rem;margin-left:-20rem}@media (max-width: 80rem){#toc-aside{display:none}}@media (min-width: 80rem){#toc-inline{display:none}}sup{line-height:0}.footnote-reference{color:#fbcb97}.footnote-reference:after{content:"]"}.footnote-reference:before{content:"["}.footnote-reference a{color:#fbcb97;text-decoration:none}hr{margin-top:2rem;margin-bottom:2rem}.footnote-definition{display:flex;flex-direction:row;font-size:.85rem}.footnote-definition sup{all:initial;color:rgba(255,255,255,.9);text-rendering:optimizeLegibility;font-variant-ligatures:contextual;font-family:Charter,"Bitstream Charter","Sitka Text",Cambria,serif;font-weight:450;font-size:1rem;line-height:1.58;letter-spacing:-.02em;font-size:.7rem;margin:0rem;margin-right:.5rem}.footnote-definition p{margin:0rem;margin-bottom:1rem}.footnote-definition p .footnote-backlink{margin:0rem;margin-left:.5rem;color:#fbcb97;text-decoration:none}</style>

    <meta property="og:site_name" content="Gunwant Jain - @wantguns">
      <meta name="author" content="Gunwant Jain" />
      <meta name="keywords" content="Gunwant Jain, wantguns, Gunwant, WantGuns" />
      <meta property="og:title" content="nixos-anywhere">
      <meta property="og:description" content="">
      <meta property="og:url" content="https://wantguns.dev/nixos-anywhere/">
      <meta property="og:image" content="">

      <meta name="twitter:card" content="summary">
      <meta name="twitter:title" content="Gunwant Jain - @wantguns">
      <meta name="twitter:description" content="Gunwant Jain&#x27;s (@wantguns) writings and musings">

      <meta property="og:type" content="article" />
        <meta property="article:published_time" content="2025-04-10T00:00:00+00:00" />

      
      
    

  </head>
  

  <body>
    <main id="main" role="main">
      
      <header role="banner">
          
            
            <nav style="margin-bottom:1rem;" role="navigation">
              
                <a class="site_nav" href="https://wantguns.dev/about">about</a>
                
                  <span>&nbsp</span>
                
              
                <a class="site_nav" href="https://wantguns.dev">blog</a>
                
                  <span>&nbsp</span>
                
              
                <a class="site_nav" href="https://wantguns.dev/tags">tags</a>
                
                  <span>&nbsp</span>
                
              
                <a class="site_nav" href="https://bin.wantguns.dev/cv">resume</a>
                
                  <span>&nbsp</span>
                
              
                <a class="site_nav" href="https://wantguns.dev/atom.xml">rss</a>
                
              
            </nav>
            
          
      </header>
      


    <div>

      
<article>
  <h1 class="page_title">nixos-anywhere</h1>

  
    <span class="page_time">Posted on <time datetime="2025-04-10T00:00:00+00:00">April 10, 2025</time></span>
    
    <span class="time_tag_sep">&middot;</span>
    <span class="post_tags">
        
            <a href="https://wantguns.dev/tags/yakshaving/">#yakshaving</a>
        
            <a href="https://wantguns.dev/tags/selfhosting/">#selfhosting</a>
        
            <a href="https://wantguns.dev/tags/nix/">#nix</a>
        
    </span>
    
  

  
  
    
    <details id = "toc-inline">
        <summary><b>Table of Contents</b></summary>
        <ul>
            <li>
                <a href="#setting-up-my-physical-homeserver">Setting up my physical homeserver</a>
                <ul>
                    <li>
                        <a href="#adding-the-host-to-the-flake">Adding the host to the flake</a>
                    </li><li>
                        <a href="#booting">Booting</a>
                    </li><li>
                        <a href="#nixos-facter">nixos-facter</a>
                    </li><li>
                        <a href="#disko">disko</a>
                    </li><li>
                        <a href="#installing">Installing</a>
                    </li>
                </ul>
            </li><li>
                <a href="#setting-up-my-oracle-vm">Setting up my Oracle VM</a>
                <ul>
                    <li>
                        <a href="#facter">Facter</a>
                    </li><li>
                        <a href="#adding-the-host-on-my-flake">Adding the host on my flake</a>
                    </li><li>
                        <a href="#installing-using-kexec">Installing using kexec</a>
                    </li>
                </ul>
            </li><li>
                <a href="#concluding">Concluding</a>
                
            </li>
        </ul>
    </details>

    
  <aside id="toc-aside">
          <h4>Table of Contents</h4>
      <ul>
          
          <li>
              <a href="#setting-up-my-physical-homeserver">Setting up my physical homeserver</a>
              
              <ul>
                  
                  <li>
                      <a href="#adding-the-host-to-the-flake">Adding the host to the flake</a>
                  </li>
                  
                  <li>
                      <a href="#booting">Booting</a>
                  </li>
                  
                  <li>
                      <a href="#nixos-facter">nixos-facter</a>
                  </li>
                  
                  <li>
                      <a href="#disko">disko</a>
                  </li>
                  
                  <li>
                      <a href="#installing">Installing</a>
                  </li>
                  
              </ul>
              
          </li>
          <li>
              <a href="#setting-up-my-oracle-vm">Setting up my Oracle VM</a>
              
              <ul>
                  
                  <li>
                      <a href="#facter">Facter</a>
                  </li>
                  
                  <li>
                      <a href="#adding-the-host-on-my-flake">Adding the host on my flake</a>
                  </li>
                  
                  <li>
                      <a href="#installing-using-kexec">Installing using kexec</a>
                  </li>
                  
              </ul>
              
          </li>
          <li>
              <a href="#concluding">Concluding</a>
              
          </li>
      </ul>
  </aside>

  
  

  <p><code>nixos-anywhere</code> is a cool tool which can be used to installed nixos on:</p>
<ul>
<li>an existing linux installation using kexec</li>
<li>a baremetal machine</li>
<li>and both of those options remotely using ssh</li>
</ul>
<p>It is a part of the <a href="https://github.com/nix-community">nix-community</a> suite,
and works well with
<a href="https://github.com/nix-community/nixos-facter">nixos-facter</a> for specifying
the hardware configuration and <a href="https://github.com/nix-community/disko">disko</a>
for declarative disk layout management.</p>
<p>It is meant to run once and if successful you are left with your
desired NixOS configured according to your <code>nixosConfigurations</code>.</p>
<h2 id="setting-up-my-physical-homeserver">Setting up my physical homeserver</h2>
<p>Let's set up the Dell Optiplex 3040 I am going to use as my homeserver. I'll
call this host <code>mintaka</code>.</p>
<p>The Optiplex was set to boot on BIOS by default, I changed that to UEFI
from the motherboard settings.</p>
<h3 id="adding-the-host-to-the-flake">Adding the host to the flake</h3>
<p>Simply define the host in the flake.nix</p>
<pre data-lang="nix" style="background-color:#000000;color:#c1c1c1;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#888888;"># inside flake.nix
</span><span style="font-style:italic;color:#5f8787;">hosts </span><span style="background-color:#5f8787;color:#000000;">=</span><span> {
</span><span>    </span><span style="color:#888888;"># ...
</span><span>
</span><span>    </span><span style="color:#fbcb97;">&quot;mintaka&quot; </span><span style="color:#e78a53;">= </span><span style="font-style:italic;color:#5f8787;">lib</span><span style="color:#e78a53;">.</span><span style="font-style:italic;color:#5f8787;">my</span><span style="color:#e78a53;">.</span><span style="font-style:italic;color:#5f8787;">mkHostConfig </span><span>{
</span><span>      </span><span style="color:#e78a53;">hostname = </span><span style="color:#fbcb97;">&quot;mintaka&quot;</span><span>;
</span><span>      </span><span style="color:#e78a53;">system = </span><span style="color:#fbcb97;">&quot;x86_64-linux&quot;</span><span>;
</span><span>      </span><span style="color:#e78a53;">username = </span><span style="color:#fbcb97;">&quot;wantguns&quot;</span><span>;
</span><span>      </span><span style="color:#e78a53;">remoteBuild = true</span><span>;
</span><span>      </span><span style="color:#e78a53;">ips = </span><span>{
</span><span>        </span><span style="color:#e78a53;">private = </span><span style="color:#fbcb97;">&quot;192.168.1.130&quot;</span><span>;
</span><span>      };
</span><span>    };
</span><span>}
</span></code></pre>
<h3 id="booting">Booting</h3>
<p>First, I created a bootable disk using an iso which supports
<code>nixos-facter</code>, I am using
<a href="https://github.com/nix-community/nixos-images">nixos-community/nixos-images</a></p>
<p>And boot it on <code>mintaka</code>, add my ssh key:</p>
<pre data-lang="bash" style="background-color:#000000;color:#c1c1c1;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5f8787;">mkdir</span><span style="font-style:italic;color:#5f8787;"> -p</span><span> .ssh</span><span style="color:#e78a53;">; </span><span style="color:#fbcb97;">echo &quot;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHcueIcj4fgzD6cUUGqituoupjexNNF1Hjrr+dyJ+gvA gunwant.jain@C02GH2V9MD6M.local&quot; </span><span style="color:#e78a53;">&gt;&gt;</span><span> .ssh/authorized_keys
</span></code></pre>
<h3 id="nixos-facter">nixos-facter</h3>
<p>I am going to generate the hardware configuration for <code>mintaka</code> using
nixos-facter:</p>
<pre data-lang="bash" style="background-color:#000000;color:#c1c1c1;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5f8787;">nixos-facter </span><span style="color:#e78a53;">&gt;</span><span> hosts/linux/mintaka/facter.json
</span></code></pre>
<p>I'll add this copy of <code>facter.json</code> to my nix flake.</p>
<h3 id="disko">disko</h3>
<p>Next, I'll declare my disk layout. I am choosing to try ZFS for the
first time. Other machines that I own run on BTRFS, and I haven't faced
any data loss as of now, but I also wanted to give OpenZFS a shot:</p>
<pre data-lang="nix" style="background-color:#000000;color:#c1c1c1;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#888888;"># inside hosts/linux/mintaka/disk-config.nix
</span><span>{
</span><span>  </span><span style="color:#e78a53;">disko</span><span>.</span><span style="color:#e78a53;">devices = </span><span>{
</span><span>    </span><span style="color:#e78a53;">disk = </span><span>{
</span><span>      </span><span style="color:#e78a53;">main = </span><span>{
</span><span>        </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;disk&quot;</span><span>;
</span><span>        </span><span style="color:#e78a53;">device = </span><span style="color:#fbcb97;">&quot;/dev/sda&quot;</span><span>;
</span><span>        </span><span style="color:#e78a53;">content = </span><span>{
</span><span>          </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;gpt&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">partitions = </span><span>{
</span><span>            </span><span style="color:#e78a53;">ESP = </span><span>{
</span><span>              </span><span style="color:#e78a53;">size = </span><span style="color:#fbcb97;">&quot;512M&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;EF00&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">content = </span><span>{
</span><span>                </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;filesystem&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">format = </span><span style="color:#fbcb97;">&quot;vfat&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/boot&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">mountOptions = </span><span>[ </span><span style="color:#fbcb97;">&quot;defaults&quot; </span><span>];
</span><span>              };
</span><span>            };
</span><span>            </span><span style="color:#e78a53;">zfs = </span><span>{
</span><span>              </span><span style="color:#e78a53;">size = </span><span style="color:#fbcb97;">&quot;100%&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">content = </span><span>{
</span><span>                </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">pool = </span><span style="color:#fbcb97;">&quot;zroot&quot;</span><span>;
</span><span>              };
</span><span>            };
</span><span>          };
</span><span>        };
</span><span>      };
</span><span>    };
</span><span>    </span><span style="color:#e78a53;">zpool = </span><span>{
</span><span>      </span><span style="color:#e78a53;">zroot = </span><span>{
</span><span>        </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zpool&quot;</span><span>;
</span><span>        </span><span style="color:#e78a53;">rootFsOptions = </span><span>{
</span><span>          </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;none&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">compression = </span><span style="color:#fbcb97;">&quot;zstd&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">acltype = </span><span style="color:#fbcb97;">&quot;posixacl&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">xattr = </span><span style="color:#fbcb97;">&quot;sa&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">atime = </span><span style="color:#fbcb97;">&quot;off&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">relatime = </span><span style="color:#fbcb97;">&quot;on&quot;</span><span>;
</span><span>          </span><span style="color:#fbcb97;">&quot;com.sun:auto-snapshot&quot; </span><span style="color:#e78a53;">= </span><span style="color:#fbcb97;">&quot;false&quot;</span><span>;
</span><span>        };
</span><span>        </span><span style="color:#e78a53;">options = </span><span>{
</span><span>          </span><span style="color:#e78a53;">ashift = </span><span style="color:#fbcb97;">&quot;12&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">autotrim = </span><span style="color:#fbcb97;">&quot;on&quot;</span><span>;
</span><span>        };
</span><span>
</span><span>        </span><span style="color:#e78a53;">datasets = </span><span>{
</span><span>          </span><span style="color:#fbcb97;">&quot;root&quot; </span><span style="color:#e78a53;">= </span><span>{
</span><span>            </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs_fs&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/&quot;</span><span>;
</span><span>          };
</span><span>          </span><span style="color:#fbcb97;">&quot;root/nix&quot; </span><span style="color:#e78a53;">= </span><span>{
</span><span>            </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs_fs&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/nix&quot;</span><span>;
</span><span>          };
</span><span>          </span><span style="color:#fbcb97;">&quot;root/var&quot; </span><span style="color:#e78a53;">= </span><span>{
</span><span>            </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs_fs&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/var&quot;</span><span>;
</span><span>          };
</span><span>          </span><span style="color:#fbcb97;">&quot;root/var/log&quot; </span><span style="color:#e78a53;">= </span><span>{
</span><span>            </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs_fs&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/var/log&quot;</span><span>;
</span><span>          };
</span><span>          </span><span style="color:#fbcb97;">&quot;root/home&quot; </span><span style="color:#e78a53;">= </span><span>{
</span><span>            </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs_fs&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/home&quot;</span><span>;
</span><span>          };
</span><span>          </span><span style="color:#fbcb97;">&quot;root/swap&quot; </span><span style="color:#e78a53;">= </span><span>{
</span><span>            </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;zfs_volume&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">size = </span><span style="color:#fbcb97;">&quot;4G&quot;</span><span>;
</span><span>            </span><span style="color:#e78a53;">content = </span><span>{
</span><span>              </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;swap&quot;</span><span>;
</span><span>            };
</span><span>            </span><span style="color:#e78a53;">options = </span><span>{
</span><span>              </span><span style="color:#e78a53;">volblocksize = </span><span style="color:#fbcb97;">&quot;4096&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">compression = </span><span style="color:#fbcb97;">&quot;zle&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">logbias = </span><span style="color:#fbcb97;">&quot;throughput&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">sync = </span><span style="color:#fbcb97;">&quot;always&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">primarycache = </span><span style="color:#fbcb97;">&quot;metadata&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">secondarycache = </span><span style="color:#fbcb97;">&quot;none&quot;</span><span>;
</span><span>              </span><span style="color:#fbcb97;">&quot;com.sun:auto-snapshot&quot; </span><span style="color:#e78a53;">= </span><span style="color:#fbcb97;">&quot;false&quot;</span><span>;
</span><span>            };
</span><span>          };
</span><span>        };
</span><span>      };
</span><span>    };
</span><span>  };
</span><span>}
</span></code></pre>
<p>I had already configured our nix flake to include the modules for disko
and our facter config with the nixosSystem builder in a previous blog <sup class="footnote-reference"><a href="#1">1</a></sup>.</p>
<h3 id="installing">Installing</h3>
<p>We can finally use the nix flake to install NixOS on <code>mintaka</code>.
<code>nixos-anywhere</code> looks for nixosConfiguration in the flake. I copied the
nix flake to the host and ran:</p>
<pre data-lang="bash" style="background-color:#000000;color:#c1c1c1;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5f8787;">nix</span><span> run github:nix-community/nixos-anywhere</span><span style="color:#e78a53;"> --</span><span> --flake .#mintaka --target-host root@127.0.0.1 --build-on remote
</span></code></pre>
<p>And after some time, the machine rebooted and I was presented with a
fresh OS install, with all my dotfiles and settings configured. For the
up-to-date summary of changes I have made on my host, I can now refer to
its <a href="https://github.com/wantguns/dotfiles/commits/nix/hosts/linux/mintaka">git history</a></p>
<h2 id="setting-up-my-oracle-vm">Setting up my Oracle VM</h2>
<p>Back when Oracle generously started handing out free instances, I
quickly got one in the Mumbai region. Oracle's choices for host
operating systems were limited and I went ahead with Ubuntu Linux at
that time.</p>
<p>It is a meaty 4 arm64 core and 24GiB ram server, which I definetely want
to include in my fleet of servers. It also acted as test bed for remote
installtions and its the first and only arm64 machine in my fleet.</p>
<p>I am naming this server <code>bellatrix</code>. Let's get started.</p>
<h3 id="facter">Facter</h3>
<p>This VM was so old that facter failed to get some udev environment
variables which were added 2 years ago in systemd. I worked around this
by checking systemd's codebase history and posted my method on a
recently open github issue (now closed):<br />
<a href="https://github.com/nix-community/nixos-facter/issues/184#issuecomment-2746239524">nix-community/nixos-facter #184</a></p>
<h3 id="adding-the-host-on-my-flake">Adding the host on my flake</h3>
<p>I can finally bear the fruits of my labor, adding a new host is as easy
as adding a new commit:<br />
<a href="https://github.com/wantguns/dotfiles/commit/7580411c0ecb7f2f8a3dbcc1f1589b4e5c5867cb">wantguns/dotfiles: hosts: onboard bellatrix</a></p>
<p>Here is the host attribute set entry:</p>
<pre data-lang="nix" style="background-color:#000000;color:#c1c1c1;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#fbcb97;">&quot;bellatrix&quot; </span><span style="background-color:#5f8787;color:#000000;">=</span><span> </span><span style="font-style:italic;color:#5f8787;">lib</span><span style="color:#e78a53;">.</span><span style="font-style:italic;color:#5f8787;">my</span><span style="color:#e78a53;">.</span><span style="font-style:italic;color:#5f8787;">mkHostConfig </span><span>{
</span><span>  </span><span style="color:#e78a53;">hostname = </span><span style="color:#fbcb97;">&quot;bellatrix&quot;</span><span>;
</span><span>  </span><span style="color:#e78a53;">system = </span><span style="color:#fbcb97;">&quot;aarch64-linux&quot;</span><span>;
</span><span>  </span><span style="color:#e78a53;">username = </span><span style="color:#fbcb97;">&quot;wantguns&quot;</span><span>;
</span><span>  </span><span style="color:#e78a53;">remoteBuild = true</span><span>;
</span><span>  </span><span style="color:#e78a53;">ips = </span><span>{
</span><span>    </span><span style="color:#e78a53;">public = </span><span style="color:#fbcb97;">&quot;&lt;public-ip&gt;&quot;</span><span>;
</span><span>  };
</span><span>}</span><span style="background-color:#5f8787;color:#000000;">;</span><span>
</span></code></pre>
<p>And this is disk config:</p>
<pre data-lang="nix" style="background-color:#000000;color:#c1c1c1;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#888888;"># Preserving the original fs layout
</span><span>{
</span><span>  </span><span style="color:#e78a53;">disko</span><span>.</span><span style="color:#e78a53;">devices = </span><span>{
</span><span>    </span><span style="color:#e78a53;">disk = </span><span>{
</span><span>      </span><span style="color:#e78a53;">main = </span><span>{
</span><span>        </span><span style="color:#e78a53;">device = </span><span style="color:#fbcb97;">&quot;/dev/sda&quot;</span><span>;
</span><span>        </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;disk&quot;</span><span>;
</span><span>        </span><span style="color:#e78a53;">content = </span><span>{
</span><span>          </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;gpt&quot;</span><span>;
</span><span>          </span><span style="color:#e78a53;">partitions = </span><span>{
</span><span>            </span><span style="color:#e78a53;">ESP = </span><span>{
</span><span>              </span><span style="color:#e78a53;">size = </span><span style="color:#fbcb97;">&quot;100M&quot;</span><span>;
</span><span>              </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;EF00&quot;</span><span>;  </span><span style="color:#888888;"># EFI System Partition
</span><span>              </span><span style="color:#e78a53;">content = </span><span>{
</span><span>                </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;filesystem&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">format = </span><span style="color:#fbcb97;">&quot;vfat&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/boot&quot;</span><span>;
</span><span>              };
</span><span>            };
</span><span>            </span><span style="color:#e78a53;">root = </span><span>{
</span><span>              </span><span style="color:#e78a53;">size = </span><span style="color:#fbcb97;">&quot;100%&quot;</span><span>;  </span><span style="color:#888888;"># Use all remaining space
</span><span>              </span><span style="color:#e78a53;">content = </span><span>{
</span><span>                </span><span style="color:#e78a53;">type = </span><span style="color:#fbcb97;">&quot;filesystem&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">format = </span><span style="color:#fbcb97;">&quot;ext4&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">mountpoint = </span><span style="color:#fbcb97;">&quot;/&quot;</span><span>;
</span><span>                </span><span style="color:#e78a53;">extraArgs = </span><span>[</span><span style="color:#fbcb97;">&quot;-L&quot; &quot;cloudimg-rootfs&quot;</span><span>];  </span><span style="color:#888888;"># Preserve the LABEL from fstab
</span><span>              };
</span><span>            };
</span><span>          };
</span><span>        };
</span><span>      };
</span><span>    };
</span><span>  };
</span><span>}
</span></code></pre>
<p>I decided to not tinker with the original disk layout a lot.</p>
<h3 id="installing-using-kexec">Installing using kexec</h3>
<p>With the host added and configured, I had to run a single command to
install NixOS through <code>kexec</code> (thus overwriting the Ubuntu image):</p>
<pre data-lang="bash" style="background-color:#000000;color:#c1c1c1;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5f8787;">nix</span><span> run github:nix-community/nixos-anywhere</span><span style="color:#e78a53;"> --</span><span> --flake .#bellatrix --target-host root@</span><span style="color:#e78a53;">&lt;</span><span>public-ip</span><span style="color:#e78a53;">&gt; </span><span>--build-on remote
</span></code></pre>
<h2 id="concluding">Concluding</h2>
<p>Nix is helping me a lot to simplify operating a fleet of servers
declaratively. I can now make more changes to any of these servers by
running our <code>deploy</code> nix flake app:</p>
<pre data-lang="bash" style="background-color:#000000;color:#c1c1c1;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5f8787;">nix</span><span> run .#deploy</span><span style="color:#e78a53;"> --</span><span> mintaka true
</span><span style="color:#5f8787;">nix</span><span> run .#deploy</span><span style="color:#e78a53;"> --</span><span> bellatix true
</span></code></pre>
<p>I can run this command from a remote machine which has SSH access to the
target machine, and it just works.</p>
<p>Up next, I am going to try to create a common Wireguard
network between <code>mintaka</code> and <code>bellatrix</code> and try to create abstractions
which would make it easier for me to onboard a new Wireguard peer on my
fleet.</p>
<hr />
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>https://wantguns.dev/nixmultihost/#lib-mkhost-nix</p>
</div>

</article>


  <div class="pagination_title">
    <span>Read other posts</span>
  </div>
  <div class="post_nav">
      
        <div class="button">
          <a class="button" href="&#x2F;nixmultihost&#x2F;">
            ←&nbsp;
            <span class="next">
              Single flake, multiple hosts
            </span>
          </a>
        </div>
      
      
    </div>



    </div>
    </main>

    
    

    <footer class=center>
      <sub>
        <div>
            &copy;
            <span id="copyright">
                <script>document.getElementById('copyright').appendChild(document.createTextNode(new Date().getFullYear()))</script>
            </span>
            &middot;
            Gunwant Jain. Built <a class="footer" href="https://github.com/wantguns/wantguns.dev">openly</a> with <a class="footer" href="https://www.getzola.org">Zola</a>
        </div>
      </sub>
    </footer>
  </body>
  
 <script src=https://wantguns.dev/js/page.js></script> 

</html>
